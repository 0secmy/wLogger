<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>统计</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/layui-src@2.5.5/dist/css/layui.css">
</head>
<body>

    <!-- 你的HTML代码 -->

    <div class="layui-container">
        <div class="layui-row">
            <div class="layui-col-md12">
                <div style="" id="get_request_num_by_secends"></div>
            </div>
        </div>
        <div class="layui-row">
            <div class="layui-col-md12">
                <div style="" id="get_request_num_by_citys"></div>
            </div>
        </div>

        <div class="layui-row">
            <div class="layui-col-md12">

              <div style="" id="get_request_num_by_ip"></div>

            </div>
            <div class="layui-col-md12">

              <div style="" id="get_request_num_by_url"></div>

            </div>
            <div class="layui-col-md12">

              <div style="" id="get_request_num_by_status"></div>

            </div>
        </div>

        移动设备、平板、桌面端的不同表现：
        <div class="layui-row">
            <div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
              移动：6/12 | 平板：6/12 | 桌面：4/12
            </div>
            <div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
              移动：6/12 | 平板：6/12 | 桌面：4/12
            </div>
            <div class="layui-col-xs4 layui-col-sm12 layui-col-md4">
              移动：4/12 | 平板：12/12 | 桌面：4/12
            </div>
            <div class="layui-col-xs4 layui-col-sm7 layui-col-md8">
              移动：4/12 | 平板：7/12 | 桌面：8/12
            </div>
            <div class="layui-col-xs4 layui-col-sm5 layui-col-md4">
              移动：4/12 | 平板：5/12 | 桌面：4/12
            </div>
        </div>
    </div>



<script src="https://cdn.bootcdn.net/ajax/libs/jquery/1.10.0/jquery.js"></script>
<script src="https://cdn.jsdelivr.net/npm/layui-src@2.5.5/dist/layui.js"></script>
<script src="https://cdn.highcharts.com.cn/highcharts/highcharts.js"></script>
<script src="https://cdn.highcharts.com.cn/highcharts/modules/drilldown.js"></script>
<script src="https://cdn.highcharts.com.cn/highmaps/modules/map.js"></script>



<script>
    //一般直接写在一个js文件中
    layui.use(['layer', 'form'], function(){
      var layer = layui.layer
      ,form = layui.form;


    });

    var host = 'http://127.0.0.1:5000'
    Highcharts.setOptions({
        global: {
            useUTC: false,

        }
    });
    /*
    //实时每秒的请求量
    function get_request_num_by_secends(){
        var init_request_url = '/get_request_num_by_secends?type=init'
        var secend_request_url = '/get_request_num_by_secends'

        function filter_msg_data(d){
            _data = []

            $.each(d,function (k,v) {
                item = []
                item[0] = v.timestamp
                item[1] = v.total_request_num
                _data.push(item)
            })
            return _data
        }


        $.getJSON(host + init_request_url,function (msg) {

            init_data = filter_msg_data(msg.data)

            // 图表配置
            var options = {
                chart: {
                    type: 'spline',
                    events:{
                        load:function(){


                            var series = this.series[0];
                            setInterval(function () {

                                $.getJSON(host + secend_request_url,function (msg) {
                                    subdata = filter_msg_data(msg.data)

                                    $.each(subdata,function (k,v) {
                                        series.addPoint([ v[0], v[1] ], true, true);
                                    })

                                })

                            }, 5000);
                        }
                    }
                },
                credits: {
                    enabled: false//不显示LOGO
                },
                title: {
                        text: '今日请求量实时统计'
                },
                rangeSelector: {
                    buttons: [
                        {
                            count: 1,
                            type: 'minute',
                            text: '1分钟'
                        },
                        {
                            count: 5,
                            type: 'minute',
                            text: '5分钟'
                        },
                        {
                            count: 10,
                            type: 'minute',
                            text: '10分钟'
                        },
                        {
                            type: 'all',
                            text: '所有'
                        }
                    ],
                    inputEnabled: false,
                    selected: 0
                },
                yAxis: {
                    allowDecimals: false,
                    title: {
                        text: '请求量'
                    }
                },
                tooltip: {
                    //保留小数点后两位
                    valueDecimals: 0,
                    formatter: function () {
                        return '<b>请求量 : ' + this.y +'</b> <br/> <b>时间 : ' + Highcharts.dateFormat('%Y-%m-%d %H:%M:%S',this.x) + '</b>';

                    }

                },
                series: [{                              // 数据列
                    name: '请求量',                        // 数据列名
                    data: init_data      // 数据
                }],


            };
            // 图表初始化函数
            var chart = Highcharts.stockChart('get_request_num_by_secends', options);
        })

    }
    get_request_num_by_secends()

    */

    // 请求量前50IP占比
    function get_request_num_by_ip() {
        var init_request_url = '/get_request_num_by_ip?type=init'
        var ip_detail_request_url = '/get_request_urls_by_ip?ip='
        function filter_msg_data(data) {

            var _data = []

            $.each(data,function (k,v) {
                var item = {}
                item.name = v._id
                item.y = v.percent
                item.drilldown = true

                _data.push(item)
            })
            return _data
        }

        $.getJSON(host + init_request_url ,function (msg) {

            var data = filter_msg_data(msg.data)


            Highcharts.chart('get_request_num_by_ip', {
                chart: {
                    type: 'column',
                    events:{
                        drilldown:function(e){
                            var chart = this
                            _url = host + ip_detail_request_url + e.point.name

                            chart.showLoading('数据加载中...')
                            $.getJSON(_url ,function (msg){
                                 drilldown_data = {'name': e.point.name ,data :[]}
                                 $.each(msg.data,function (k,v) {
                                        var item = {}
                                        item.name = v._id
                                        item.y = v.total_num
                                        drilldown_data.data.push(item)
                                    })

                                chart.hideLoading()
                                chart.addSeriesAsDrilldown(e.point, drilldown_data);
                            })

                        }
                    }
                },
                title: {
                    text: '今日IP请求量最高的50'
                },
                subtitle: {
                    text: 'Tips : 点击IP可查看访问页面的详情'
                },
                xAxis: {
                    type: 'category'
                },
                yAxis: {
                    title: {
                        text: '请求占比最高的前20IP'
                    }
                },
                legend: {
                    enabled: false
                },
                plotOptions: {
                    series: {
                        borderWidth: 0,
                        dataLabels: {
                            enabled: true
                        }
                    }
                },
                tooltip: {
                    headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
                    pointFormat: '{point.name} 占总请求量的 : <b>{point.y:.2f}%</b> <br/>'
                },
                series: [{
                    name: '请求占比',
                    colorByPoint: true,
                    data: data
                }],
                drilldown: {
                    series: []
                }
            })


        })
    }
    get_request_num_by_ip()


        // 请求量前50IP占比
    function get_request_num_by_status() {
        var init_request_url = '/get_request_num_by_status?type=init'
        var code_detail_request_url = '/get_request_num_by_status_code?code='
        function filter_msg_data(data) {

            var _data = []

            $.each(data,function (k,v) {
                var item = {}
                item.name = "状态码: " + v._id
                item.y = v.total_num
                item.drilldown = true
                _data.push(item)
            })
            return _data
        }

        $.getJSON(host + init_request_url ,function (msg) {

            var data = filter_msg_data(msg.data)

            Highcharts.chart('get_request_num_by_status', {
                chart: {
                    type: 'column',
                    events:{
                        drilldown:function(e){
                            var chart = this
                            _url = host + code_detail_request_url + e.point.name

                            chart.showLoading('数据加载中...')
                            $.getJSON(_url ,function (msg){
                                 drilldown_data = {'name': e.point.name ,data :[]}
                                 $.each(msg.data,function (k,v) {
                                        var item = {}
                                        item.name = v._id
                                        item.y = v.total_num
                                        drilldown_data.data.push(item)
                                    })

                                chart.hideLoading()
                                chart.addSeriesAsDrilldown(e.point, drilldown_data);
                            })

                        }
                    }
                },
                title: {
                    text: '非200状态的请求详情'
                },
                subtitle: {
                    text: 'Tips : 点击状态码可查看对应的页面的详情'
                },
                xAxis: {
                    type: 'category'
                },
                yAxis: {
                    title: {
                        text: '状态码请求详情'
                    }
                },
                legend: {
                    enabled: false
                },
                plotOptions: {
                    series: {
                        borderWidth: 0,
                        dataLabels: {
                            enabled: true
                        }
                    }
                },
                tooltip: {
                    headerFormat: '<span style="font-size:11px"><b>{series.name}</b</span><br>',
                    pointFormat: '链接: <b>{point.name}</b> 请求量 : <b> {point.y} </b> <br/>'
                },
                series: [{
                    name: '状态码',
                    colorByPoint: true,
                    data: data
                }],
                drilldown: {
                    series: []
                }
            })


        })
    }
    get_request_num_by_status()


    // 被请求的url前50IP占比
    function get_request_num_by_url() {
        var init_request_url = '/get_request_num_by_url?type=init'
        var secend_request_url = '/get_request_num_by_url'
        function filter_msg_data(data) {
            var _data = []

            $.each(data,function (k,v) {
                var item = {}
                item.name = v.ip
                item.y = v.percent
                _data.push(item)
            })
            return _data
        }

        $.getJSON(host + init_request_url ,function (msg) {

            var data = filter_msg_data(msg.data)

            var options = {
                    chart: {
                        plotBackgroundColor: null,
                        plotBorderWidth: null,
                        plotShadow: false,
                        type: 'pie',
                        events: {
                            load:function(){

                                var series = this.series[0];
                                setInterval(function () {
                                    $.getJSON(host + init_request_url,function (msg) {
                                        subdata = filter_msg_data(msg.data)
                                        series.setData(subdata)
                                    })

                                }, 5000);
                            }
                        }
                    },
                    credits: {
                        enabled: false//不显示LOGO
                    },
                    title: {
                        text: '今日页面请求量前50IP占比'
                    },
                    tooltip: {
                        pointFormat: '{series.name} : <b>{point.percentage:.1f}%</b>'
                    },
                    plotOptions: {
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            dataLabels: {
                                enabled: true,
                                format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                                style: {
                                    color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                                }
                            }
                        }
                    },
                    series: [{
                        name: '请求占比',
                        colorByPoint: true,
                        data: data
                    }]
                }
            Highcharts.chart('get_request_num_by_url',options);
        })
    }
    get_request_num_by_url()

    // 请求来源地域
    function get_request_num_by_citys() {
        $.getJSON('https://data.jianshukeji.com/jsonp?filename=geochina/china.json&callback=?', function(mapdata) {

            var init_request_url = '/get_request_num_by_province'
            $.getJSON(host + init_request_url,function (msg) {

                var map =  Highcharts.mapChart('get_request_num_by_citys', {
                    title: {
                        text: '中国地图'
                    },
                    mapNavigation: {
                        enabled: true,
                        buttonOptions: {
                            verticalAlign: 'bottom'
                        }
                    },
                    colorAxis: {
                        min: 0,
                        minColor: '#fff',
                        maxColor: '#006cee',
                        labels:{
                            style:{
                                "color":"red","fontWeight":"bold"
                            }
                        }
                    },
                    series: [{
                        data: msg.data,
                        mapData: mapdata,
                        joinBy: 'fullname',
                        name: '全国访问请求量'
                    }]
                })
            })





        });
    }
    get_request_num_by_citys()



</script>
</body>
</html>